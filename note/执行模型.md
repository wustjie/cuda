GPU架构是围绕一个流式多处理器（Stream Multi-processor, SM）的可扩展阵列搭建的  
Fermi SM的关键组件：  
·CUDA核心  
·共享内存/一级缓存  
·寄存器文件  
·加载/存储单元  
·特殊功能单元  
·线程束调度器  

启动一个内核网格时，它的线程块被分布在了可用的SM上来执行。线程块一旦被调度到一个SM上，其中的线程只会在那个指定的SM上并发执行。  
CUDA采用单指令多线程（SIMT）架构来管理和执行线程，每32个线程为一组，被称为线程束（warp）。线程束中的所有线程同时执行相同的指令。
每个线程都有自己的指令地址计数器和寄存器状态。

Fermi架构  
![image](https://github.com/wustjie/cuda/assets/34996802/1570f69e-a37d-425b-a1b4-789b75f98a99)  
Fermi架构的一个关键特征是有一个64KB的片内可配置存储器，它在共享内存与一级缓存之间进行分配。  

Kepler架构  
3个重要创新  
·强化的SM  
·动态并行  
·Hyper-Q技术  
![image](https://github.com/wustjie/cuda/assets/34996802/6c7fb71d-6b66-435e-8e18-1f7714cc04fc)  

一个线程束中的所有线程在同一周期中必须执行相同的指令，如果一个线程执行一条指令，那么线程束中的所有线程都必须执行该指令。  
如果一个线程束中的线程产生分化（if else...），线程束将连续执行每一个分支路径，而禁用不执行这一路径的线程。线程束分化会导致性能明显地下降。  
条件分支越多，并行性削弱越严重。
![image](https://github.com/wustjie/cuda/assets/34996802/8e33a6b8-9117-439a-9fa3-b5ed84a9643e)  

解决方法1：
使用线程束方法（而不是线程方法）来交叉存取数据，可以避免线程束分化，并且设备的利用率可达到100%。条件（tid/warpSize）%2==0使分支粒度是线程束大小的倍数；
![image](https://github.com/wustjie/cuda/assets/34996802/eb415704-d61f-43f1-897c-aba40b56acda)

解决方法2（自动）：
cuda编译器分支预测Branch Prediction；  
在分支预测中，根据条件，把每个线程中的一个断定变量设置为1或0。这两种条件流路径被完全执行，但只有断定为1的指令被执行。断定为0的指令不被执行，但相应的线程也不会停止。
只有在条件语句的指令数小于某个阈值时，编译器才用断定指令替换分支指令。因此，一段很长的代码路径肯定会导致线程束分化。

重要提示：
·当一个分化的线程采取不同的代码路径时，会产生线程束分化  
·不同的if-then-else分支会连续执行  
·尝试调整分支粒度以适应线程束大小的倍数，避免线程束分化  
·不同的分化可以执行不同的代码且无须以牺牲性能为代价  

资源分配
若每个线程消耗的寄存器越多，则可以放在一个SM中的线程束就越少。  
若一个线程块消耗的共享内存越多，则在一个SM中可以被同时处理的线程块就会变少。  
![image](https://github.com/wustjie/cuda/assets/34996802/1f807090-0f25-4be6-80c2-6e952cfa69db)

线程块被分配资源后变成活跃状态，块中的线程束可以进一步被分为以下3种类型：  
·选定的线程束  
·阻塞的线程束  
·符合条件的线程束  
同时满足以下两个条件则线程束符合执行条件。  
·32个CUDA核心可用于执行  
·当前指令中所有的参数都已就绪  

cuda栅栏
...待补充...
https://www.bilibili.com/read/cv18722474/

嵌套执行
动态并行中，内核执行分为两种类型：父母和孩子。父线程、父线程块或父网格启动一个新的网格，即子网格。子线程、子线程块或子网格被父母启动。子网格必须在父线程、父线程块或父网格完成之前完成。只有在所有的子网格都完成之后，父母才会完成。
![image](https://github.com/wustjie/cuda/assets/34996802/3c54393c-7315-4fbb-b2ad-3975bd1232d4)  

父网格和子网格共享相同的全局和常量内存存储，但它们有不同的局部内存和共享内存。  

GPU上嵌套hello world,GPU上的递归  
![image](https://github.com/wustjie/cuda/assets/34996802/530064a1-0543-4b79-ae31-d5d99829fd30)  
但是相较于使用相邻配对方法的内核实现，嵌套内核慢到无法接受。  


